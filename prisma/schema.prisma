// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "mysql"
}

enum LetterCategory {
  faculty
  study_program
  university
  all
}

enum SignatureType {
  digital
  barcode
}

enum StudentLetterStatus {
  pending
  waiting_signature
  approved
  rejected
}

enum InstitutionType {
  university
  faculty
  study_program
  institution
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  personnel                Personnel?
  student                  Student?
  userRoles                UserRoles[]
  activeTokens             ActiveToken[]
  generalLetterSubmissions GeneralLetterSubmission[]
  letters                  Letter[]
  letterHeads              LetterHead[]
}

model Institution {
  id        Int             @id @default(autoincrement())
  name      String          @unique
  address   String?
  type      InstitutionType
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  personnels               Personnel[]
  officials                Official[]
  students                 Student[]
  letterHeads              LetterHead[]
  letters                  Letter[]
  generalLetterSubmissions GeneralLetterSubmission[]
}

model Personnel {
  id            Int          @id @default(autoincrement())
  name          String
  position      String
  institution   Institution? @relation(fields: [institutionId], references: [id])
  institutionId Int?
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        Int          @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model Official {
  id                       Int                       @id @default(autoincrement())
  name                     String
  occupation               String
  nip                      String
  institution              Institution?              @relation(fields: [institutionId], references: [id])
  institutionId            Int?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  letterSignatureTemplates LetterSignatureTemplate[]
}

model Student {
  id                       Int                       @id @default(autoincrement())
  user                     User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                   Int                       @unique
  institution              Institution               @relation(fields: [institutionId], references: [id])
  institutionId            Int
  fullname                 String
  nim                      String                    @unique
  classYear                String
  address                  String
  phoneNumber              String?
  birthday                 DateTime?
  birthplace               String?
  gender                   String
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  studentLetterSubmissions StudentLetterSubmission[]
}

model Role {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userRoles       UserRoles[]
}

model Permission {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       Int
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([roleId, permissionId])
}

model UserRoles {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  role      Role     @relation(fields: [roleId], references: [id])
  roleId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, roleId])
}

model ActiveToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Letter {
  id                   Int            @id @default(autoincrement())
  institution          Institution    @relation(fields: [institutionId], references: [id])
  institutionId        Int
  user                 User           @relation(fields: [userId], references: [id])
  userId               Int
  letterHeadId         Int?
  letterHead           LetterHead?    @relation(fields: [letterHeadId], references: [id])
  letterName           String
  referenceNumber      String?
  expiredDate          Int?
  letterNumberingStart Int?
  category             LetterCategory
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  letterTemplates          LetterTemplate[]
  letterSignatureTemplates LetterSignatureTemplate[]
  studentLetterSubmissions StudentLetterSubmission[]
  generalLetterSubmissions GeneralLetterSubmission[]
  letterDocuments          LetterDocument[]
  letterAttributes         LetterAttribute[]
}

model LetterHead {
  id            Int          @id @default(autoincrement())
  institutionId Int?
  institution   Institution? @relation(fields: [institutionId], references: [id])
  user          User         @relation(fields: [userId], references: [id])
  userId        Int
  name          String
  header        String
  subheader     String
  address       String
  logo          String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  letter Letter[]
}

model LetterTemplate {
  id        Int      @id @default(autoincrement())
  letterId  Int
  letter    Letter   @relation(fields: [letterId], references: [id], onDelete: Cascade)
  content   String   @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LetterSignatureTemplate {
  id               Int               @id @default(autoincrement())
  letterId         Int
  letter           Letter            @relation(fields: [letterId], references: [id], onDelete: Cascade)
  officialId       Int
  official         Official          @relation(fields: [officialId], references: [id], onDelete: Cascade)
  position         String            @default("right")
  token            String?
  isAcknowledged   Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  letterSignatures LetterSignature[]
}

model StudentLetterSubmission {
  id                         Int                         @id @default(autoincrement())
  token                      String                      @unique
  studentId                  Int
  student                    Student                     @relation(fields: [studentId], references: [id])
  letterId                   Int
  letter                     Letter                      @relation(fields: [letterId], references: [id])
  letterNumber               String?
  letterDate                 DateTime?
  name                       String?
  signatureType              SignatureType?
  carbonCopy                 String?                     @db.LongText
  status                     StudentLetterStatus
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  letterSignatures           LetterSignature[]
  documentSubmissions        DocumentSubmission[]
  letterAttributeSubmissions LetterAttributeSubmission[]
  letterAttachments          LetterAttachment[]
}

model LetterAttachment {
  id                        Int                      @id @default(autoincrement())
  studentLetterSubmissionId Int?
  studentLetterSubmission   StudentLetterSubmission? @relation(fields: [studentLetterSubmissionId], references: [id], onDelete: Cascade)
  generalLetterSubmissionId Int?
  generalLetterSubmission   GeneralLetterSubmission? @relation(fields: [generalLetterSubmissionId], references: [id], onDelete: Cascade)
  content                   String                   @db.LongText
  isVisible                 Boolean                  @default(false)
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
}

model GeneralLetterSubmission {
  id                         Int                         @id @default(autoincrement())
  token                      String                      @unique
  userId                     Int
  user                       User                        @relation(fields: [userId], references: [id])
  institutionId              Int
  institution                Institution                 @relation(fields: [institutionId], references: [id])
  letterId                   Int
  letter                     Letter                      @relation(fields: [letterId], references: [id])
  letterNumber               String?
  name                       String?
  letterDate                 DateTime?
  carbonCopy                 String?                     @db.LongText
  signatureType              SignatureType
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  letterSignatures           LetterSignature[]
  letterAttributeSubmissions LetterAttributeSubmission[]
  letterAttachments          LetterAttachment[]
}

model LetterSignature {
  id                        Int                      @id @default(autoincrement())
  studentLetterSubmissionId Int?
  studentLetterSubmission   StudentLetterSubmission? @relation(fields: [studentLetterSubmissionId], references: [id], onDelete: Cascade)
  generalLetterSubmissionId Int?
  generalLetterSubmission   GeneralLetterSubmission? @relation(fields: [generalLetterSubmissionId], references: [id], onDelete: Cascade)
  letterSignatureTemplateId Int
  letterSignatureTemplate   LetterSignatureTemplate  @relation(fields: [letterSignatureTemplateId], references: [id], onDelete: Cascade)
  signature                 String?                  @db.LongText
  verifiedAt                DateTime?
  token                     String
  code                      String
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
}

model LetterDocument {
  id                  Int                  @id @default(autoincrement())
  letterId            Int
  letter              Letter               @relation(fields: [letterId], references: [id], onDelete: Cascade)
  documentName        String
  fileType            String               @default("pdf")
  isRequired          Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  documentSubmissions DocumentSubmission[]
}

model DocumentSubmission {
  id                        Int                     @id @default(autoincrement())
  studentLetterSubmissionId Int
  studentLetterSubmission   StudentLetterSubmission @relation(fields: [studentLetterSubmissionId], references: [id], onDelete: Cascade)
  letterDocumentId          Int
  letterDocument            LetterDocument          @relation(fields: [letterDocumentId], references: [id])
  filePath                  String
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
}

model LetterAttribute {
  id                         Int                         @id @default(autoincrement())
  letterId                   Int
  letter                     Letter                      @relation(fields: [letterId], references: [id])
  attributeName              String
  placeholder                String
  label                      String
  type                       String
  isRequired                 Boolean                     @default(false)
  isVisible                  Boolean                     @default(true)
  isEditable                 Boolean                     @default(true)
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  letterAttributeSubmissions LetterAttributeSubmission[]
}

model LetterAttributeSubmission {
  id                        Int                      @id @default(autoincrement())
  letterAttributeId         Int
  letterAttribute           LetterAttribute          @relation(fields: [letterAttributeId], references: [id])
  studentLetterSubmissionId Int?
  studentLetterSubmission   StudentLetterSubmission? @relation(fields: [studentLetterSubmissionId], references: [id])
  generalLetterSubmissionId Int?
  generalLetterSubmission   GeneralLetterSubmission? @relation(fields: [generalLetterSubmissionId], references: [id])
  content                   String
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
}
